#Key Levels Chart Indicator
#Author: TradeArcher2020
#Version: 0.2
#Date Created: 10/18/2020

def currentAggPrd = GetAggregationPeriod();
def isIntraDay = currentAggPrd < AggregationPeriod.DAY;

def dayMinAggPrd = if(currentAggPrd > AggregationPeriod.DAY, currentAggPrd, AggregationPeriod.DAY);
#Begin Previous Day's Close
plot previousDaysClose = close(period=dayMinAggPrd)[1];
previousDaysClose.SetDefaultColor(color = Color.LIGHT_GRAY);
previousDaysClose.SetStyle(Curve.LONG_DASH);
previousDaysClose.setHiding(!isIntraDay);
#End Previous Day's Close

#Begin Previous Day's Open
plot previousDaysOpen = open(period=dayMinAggPrd)[1];
previousDaysOpen.SetDefaultColor(color = Color.LIGHT_GRAY);
previousDaysOpen.SetStyle(Curve.LONG_DASH);
previousDaysOpen.setHiding(!isIntraDay);
#End Previous Day's Close

#Begin Previous Day's High
plot previousDaysHigh = high(period=dayMinAggPrd)[1];
previousDaysHigh.SetDefaultColor(color = Color.LIGHT_GRAY);
previousDaysHigh.SetStyle(Curve.LONG_DASH);
previousDaysHigh.setHiding(!isIntraDay);
#End Previous Day's Close

#Begin Previous Day's Low
plot previousDaysLow = low(period=dayMinAggPrd)[1];
previousDaysLow.SetDefaultColor(color = Color.LIGHT_GRAY);
previousDaysLow.SetStyle(Curve.LONG_DASH);
previousDaysLow.setHiding(!isIntraDay);
#End Previous Day's Close

#Begin Today's Open
def todaysOpen = open(period = dayMinAggPrd);
plot dailyOpen = todaysOpen;
dailyOpen.AssignValueColor(if IsNaN(close) then Color.LIGHT_GRAY else if close < dailyOpen then Color.DOWNTICK else Color.UPTICK);
dailyOpen.SetStyle(Curve.LONG_DASH);
dailyOpen.setHiding(!isIntraDay);
#End Today's Open

#Begin Today's Close
def beforeStart = GetTime() < RegularTradingStart(GetYYYYMMDD());
def afterEnd = GetTime() > RegularTradingEnd(GetYYYYMMDD());
#def lastSessionEndTime = RegularTradingEnd(GetYYYYMMDD());
#def minutesSinceClose = SecondsFromTime(0400) / 60;

def isAfterHours = isIntraDay and !beforeStart and afterEnd;
#def isPreMarket = beforeStart and !afterEnd;
def isMarketHours = isIntraDay and !beforeStart and !afterEnd;

plot todaysClose = if isMarketHours then close(period = dayMinAggPrd, priceType = PriceType.LAST) else if isAfterHours then close(period = dayMinAggPrd, priceType = PriceType.LAST)[0] else close(period = dayMinAggPrd, priceType = PriceType.LAST)[1];
todaysClose.SetDefaultColor(color = Color.LIGHT_GRAY);
todaysClose.SetStyle(Curve.SHORT_DASH);
todaysClose.setHiding(!isIntraDay);
#End Today's Close

#Begin Pre-Market High
def h = high;
def bar = BarNumber();
def isOutsideTradingHours = GetTime() > RegularTradingEnd(GetYYYYMMDD()) or GetTime() < RegularTradingStart(GetYYYYMMDD());
def overNightHigh = if isOutsideTradingHours and !isOutsideTradingHours[1] then h else if isOutsideTradingHours and h > overNightHigh[1] then h else overNightHigh[1];
def overNightHighBar = if isOutsideTradingHours and h == overNightHigh then bar else Double.NaN;
def overNightHighest = if BarNumber() == HighestAll(overNightHighBar) then overNightHigh else overNightHighest[1];

plot overNightHighestLine = if(!isIntraDay, Double.NaN, overNightHighest);
overNightHighestLine.SetDefaultColor(color = Color.LIGHT_GREEN);
overNightHighestLine.SetLineWeight(2);
overNightHighestLine.SetStyle(Curve.SHORT_DASH);
overNightHighestLine.setHiding(!isIntraDay);
#End Pre-MarketForecast High

#Begin Pre-Market Low
def l = low;
def overNightLow = if isOutsideTradingHours and !isOutsideTradingHours[1] then l else if isOutsideTradingHours and l < overNightLow[1] then l else overNightLow[1];
def overNightLowBar = if isOutsideTradingHours and l == overNightLow then bar else Double.NaN;
def overNightLowest = if BarNumber() == HighestAll(overNightLowBar) then overNightLow else overNightLowest[1];

plot overNightLowestLine = if(!isIntraDay, Double.NaN, overNightLowest);
overNightLowestLine.SetDefaultColor(color = Color.LIGHT_GRAY);
overNightLowestLine.SetStyle(Curve.SHORT_DASH);
overNightLowestLine.setHiding(!isIntraDay);
#End Pre-MarketForecast Low

#Begin After-Market High
#End After-Market High

#Begin High Of Day
plot highOfDay = if(!isIntraDay, high, high(period = dayMinAggPrd));
highOfDay.SetDefaultColor(color = Color.LIGHT_GRAY);
highOfDay.SetStyle(Curve.SHORT_DASH);
highOfDay.setHiding(!isIntraDay);
#End High of Day

#Begin Low Of Day
plot lowOfDay = if(!isIntraDay, low, low(period = dayMinAggPrd));
lowOfDay.SetDefaultColor(color = Color.LIGHT_GRAY);
lowOfDay.SetStyle(Curve.SHORT_DASH);
lowOfDay.setHiding(!isIntraDay);
#End High of Day

#Begin Year High
plot yearlyHigh = if(!isIntraDay, Double.NaN, high(period = AggregationPeriod.YEAR));
yearlyHigh.SetDefaultColor(color = Color.LIGHT_GRAY);
yearlyHigh.SetStyle(Curve.SHORT_DASH);
#End Year High

#Begin Year Low
plot yearlyLow = if(!isIntraDay, Double.NaN, low(period = AggregationPeriod.YEAR));
yearlyLow.SetDefaultColor(color = Color.LIGHT_GRAY);
yearlyLow.SetStyle(Curve.SHORT_DASH);
#End Year Low

def atrAggPeriod = if(!isIntraDay, GetAggregationPeriod(), dayMinAggPrd); 

#Begin 52 Week H/L
plot FiftyTwoWeekHigh = if(!isIntraDay, Double.NaN, Highest(high(period = dayMinAggPrd),252));
FiftyTwoWeekHigh.SetDefaultColor(color = Color.RED);
FiftyTwoWeekHigh.SetStyle(Curve.SHORT_DASH);

plot FiftyTwoWeekLow = if(!isIntraDay, Double.NaN, Lowest(low(period = dayMinAggPrd),252));
FiftyTwoWeekLow.SetDefaultColor(color = Color.GREEN);
FiftyTwoWeekLow.SetStyle(Curve.SHORT_DASH);

#AddLabel(isIntraDay, "52Wk H/L = " + FiftyTwoWeekHigh + " / " + FiftyTwoWeekLow, Color.WHITE);
#End 52 Week H/L
